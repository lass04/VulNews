import { VisitorNav } from './../visitor-nav/visitor-nav';

import { CveSvc } from '../../core/services/cve/cve-svc';
import { Component, OnInit, NgModule } from '@angular/core';
import { forkJoin } from 'rxjs';
import { Cve } from '../../interfaces/Cve';
import { Epss } from '../../interfaces/Epss';
import { CommonModule, DatePipe } from "@angular/common";


@Component({
  selector: 'app-cve-list',
  imports:[DatePipe,CommonModule,VisitorNav],
  templateUrl: './cve-component.html'
})
export class CveComponent implements OnInit {

  loading = true;
  error = false;

  cves: Array<Cve & { epss?: Epss }> = [];

  constructor(private cveService: CveSvc) {}

  ngOnInit(): void {
    forkJoin({
      nvd: this.cveService.getLatestNvd("20"),
      epss: this.cveService.getLatestEpss()
    }).subscribe({
      next: ({ nvd, epss }) => {
        this.cves = nvd.data.map(cve => ({
          ...cve,
          epss: epss.data.find(e => e.id === cve.id)
        }));

        this.loading = false;
      },
      error: () => {
        this.error = true;
        this.loading = false;
      }
    });
  }

  cvssSeverity(score: number | null): string {
    if (score === null) return 'N/A';
    if (score >= 9) return 'CRITICAL';
    if (score >= 7) return 'HIGH';
    if (score >= 4) return 'MEDIUM';
    return 'LOW';
  }

  severityClass(score: number | null): string {
    if (score === null) return 'bg-gray-400';
    if (score >= 9) return 'bg-red-700';
    if (score >= 7) return 'bg-red-500';
    if (score >= 4) return 'bg-yellow-500';
    return 'bg-green-500';
  }

  epssRiskLabel(epss?: number): string {
    if (epss === undefined) return 'N/A';
    if (epss > 0.7) return 'High';
    if (epss > 0.3) return 'Medium';
    return 'Low';
  }
}
