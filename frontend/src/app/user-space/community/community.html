<app-navbar></app-navbar>

<section class="min-h-screen bg-gray-50 py-12 relative bg-gradient-to-br from-gray-900 via-black to-red-900 text-white">
  <div class="max-w-4xl mx-auto px-4">
    
    <!-- Header -->
    <div class="mb-10">
      <h1 class="text-3xl font-extrabold">Community <span class="text-red-700">Feed</span></h1>
      <p class="text-gray-300">Share insights, ask questions, and connect with other researchers.</p>
    </div>

    <!-- New Post Form -->
    <div class="bg-white rounded-xl shadow-md border border-red-100 p-6 mb-8">
      <textarea
        [(ngModel)]="newPostContent"
        placeholder="What's on your mind regarding cybersecurity?"
        class="text-black w-full p-4 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none transition resize-none"
        rows="3"
      ></textarea>
      <div class="flex justify-end mt-3">
        <button
          (click)="submitPost()"
          [disabled]="isSubmitting || !newPostContent.trim()"
          class="bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-6 rounded-lg transition-all disabled:opacity-50"
        >
          {{ isSubmitting ? 'Posting...' : 'Post Discussion' }}
        </button>
      </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading" class="text-center py-10">
      <div class="animate-spin radial-progress text-red-700">‚è≥</div>
      <p class="text-gray-500 mt-2">Fetching community vibes...</p>
    </div>

    <!-- Posts Feed -->
    <div *ngIf="!loading" class="space-y-6">
      <article
        *ngFor="let post of posts"
        class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 hover:shadow-md transition-shadow"
      >
        <!-- Post Header -->
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-red-700 flex items-center justify-center text-white font-bold">
              {{ post.author.firstName.charAt(0).toUpperCase() || 'U' }}
            </div>
            <div>
              <h4 class="font-bold text-gray-800">{{ post.author.firstName + ' ' + post.author.lastName }}</h4>
              <p class="text-xs text-gray-500">{{ post.createdAt | date:'medium' }}</p>
            </div>
          </div>
        </div>

        <!-- Post Content -->
        <p class="text-gray-700 leading-relaxed mb-4">
          {{ post.content }}
        </p>

        <!-- Post Actions -->
        <div class="flex items-center gap-6 border-t pt-4">
          <button
            (click)="toggleLike(post)"
            class="flex items-center gap-2 group transition"
            [ngClass]="post.likedByMe ? 'text-red-600' : 'text-gray-500 hover:text-red-600'"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              [attr.fill]="post.likedByMe ? 'currentColor' : 'none'"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"
              />
            </svg>
            <span class="font-medium">{{ post.reactions.length }}</span>
          </button>

          <button
            (click)="toggleComments(post)"
            class="flex items-center gap-2 text-gray-500 hover:text-blue-600 transition"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
              viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
            </svg>
            <span class="font-medium">
              {{ post.comments?.length || 0 }} Comments
            </span>
          </button>
        </div>

        
        <div *ngIf="post.showComments" class="mt-6 border-t pt-4">
          
          <div class="mb-4">
            <div class="flex gap-3">
              <div class="w-8 h-8 rounded-full bg-red-700 flex items-center justify-center text-white font-bold text-xs flex-shrink-0">
                {{ currentUser.firstName.charAt(0).toUpperCase() || 'U' }}
              </div>
              <div class="flex-1">
                <textarea
                  [(ngModel)]="post.newComment"
                  placeholder="Write a comment..."
                  class="text-black w-full p-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition resize-none"
                  rows="2"
                ></textarea>
                <div class="flex justify-end mt-2">
                  <button
                    (click)="addComment(post)"
                    [disabled]="!post.newComment?.trim()"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    Comment
                  </button>
                </div>
              </div>
            </div>
          </div>

         
          <div class="space-y-4">
            <div *ngIf="post.comments && post.comments.length > 0">
              <div *ngFor="let comment of post.comments" class="flex gap-3">
                <div class="w-8 h-8 rounded-full bg-gray-500 flex items-center justify-center text-white font-bold text-sm flex-shrink-0">
                  {{ comment.author.firstName.charAt(0).toUpperCase() || 'U' }}
                </div>
                <div class="flex-1">
                  <div class="bg-gray-50 rounded-lg p-3">
                    <div class="flex items-start justify-between">
                      <div class="flex-1">
                        <h5 class="font-semibold text-gray-800 text-sm">
                          {{ comment.author.firstName + ' ' + comment.author.lastName || 'Anonymous' }}
                        </h5>
                        <p class="text-gray-700 text-sm mt-1">{{ comment.content }}</p>
                      </div>
                      
                      <button
                        *ngIf="canDeleteComment(comment)"
                        (click)="deleteComment(post, comment)"
                        class="ml-2 text-red-500 hover:text-red-700 hover:bg-red-50 rounded p-1 transition flex-shrink-0"
                        title="Delete comment"
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                      </button>
                    </div>
                  </div>
                  <p class="text-xs text-gray-500 mt-1 ml-3">{{ comment.createdAt | date:'short' }}</p>
                </div>
              </div>
            </div>

            <!-- No Comments Message -->
            <div *ngIf="!post.comments || post.comments.length === 0" class="text-center py-6 text-gray-500">
              No comments yet. Be the first to comment!
            </div>
          </div>
        </div>
      </article>

      <!-- Empty State -->
      <div *ngIf="posts.length === 0" class="text-center py-20 bg-white rounded-xl border border-dashed border-gray-300">
        <p class="text-gray-500">The feed is empty. Be the first to start a conversation!</p>
      </div>
    </div>
  </div>
</section>